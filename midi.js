!function(t){try{t.MIDIjs=new Object,t.MIDIjs.initError="initializing ...";var n,s,l,u,r,d,c=6,m=null,p=0,o=32768,f=8192,g=0,a=0,I=0,b=!1,M="",w=-1,j="",y=!1,v=0,h=!1,_=100,D=null,A=null,k="libtimidity-for-worklet.js?v="+c,x=null,O=new Array,C=440,E=new Int32Array(128),T=Math.pow(2,1/12);function R(e){var t=0;return void 0!==e&&(!0===e?t=-1:!isNaN(e)&&0<e&&(t=e)),t}var N=!1;function q(e,t){for(var n=0;n<document.scripts.length;n++){var r=document.scripts[n].src;if(ce==r){if(N)return void t();var o=newjs.onload;return newjs.onreadystatechange=function(){"loaded"!==newjs.readyState&&"complete"!==newjs.readyState||(newjs.onreadystatechange=null,N=!0,o(),t())},void(newjs.onload=function(){N=!0,o(),t()})}}var a=document.getElementsByTagName("script")[0];newjs=document.createElement("script"),newjs.onreadystatechange=function(){"loaded"!==newjs.readyState&&"complete"!==newjs.readyState||(newjs.onreadystatechange=null,N=!0,t())},newjs.onload=function(){N=!0,t()},newjs.onerror=function(){Y("Error: Cannot load  JavaScript file "+e)},newjs.src=e,newjs.type="text/javascript",a.parentNode.insertBefore(newjs,a)}function P(e){if(!I||!b)return Y("process(): No song started, returning true"),!0;if(0==(a=Module.ccall("mid_song_read_wave","number",["number","number","number","number"],[I,s,2*f,y])))return Y("Reached end of song"),U(),void(b=!1);for(var t=0;t<f;t++)e.outputBuffer.getChannelData(0)[t]=t<a/2?Module.getValue(s+2*t,"i16")/o:0;-1==w&&(w=m.currentTime)}function W(){var e=new Object;e.time=-1!=w?m.currentTime-w:0,e.status="playing",MIDIjs.player_callback&&MIDIjs.player_callback(e)}function e(){m&&m.suspend&&m.suspend()}function L(){if(m&&m.resume)return m.resume()}function H(e){m||(window.AudioContext=window.AudioContext||window.webkitAudioContext,m=new AudioContext),m.resume?m.resume().then(S(e)):S(e)}function S(e){w=-1,W(),Y("Loading libtimidity ... "),q(ce,function(){V(e,F,null)})}function V(e,t,n){if(-1!=e.indexOf("data:")){var r=e.indexOf(",")+1,o=atob(e.substring(r));u=new Uint8Array(new ArrayBuffer(o.length));for(var a=0;a<o.length;a++)u[a]=o.charCodeAt(a);return t("data:audio/x-midi ...",u,n)}Y("Loading MIDI file "+e+" ..."),n||MIDIjs.message_callback("Loading MIDI file "+e+" ...");var i=new XMLHttpRequest;i.open("GET",e,!0),i.responseType="arraybuffer",i.onerror=function(){Y("Error: Cannot retrieve MIDI file "+e)},i.onload=function(){if(200==i.status)return Y("MIDI file loaded: "+e),u=new Int8Array(i.response),t(e,u,n);Y("Error: Cannot retrieve MIDI file "+e+" : "+i.status)},i.send()}function F(e,t,n){l=Module._malloc(t.length),Module.writeArrayToMemory(t,l),rval=Module.ccall("mid_init","number",[],[]);var r=Module.ccall("mid_istream_open_mem","number",["number","number","number"],[l,t.length,!1]),t=Module.ccall("mid_create_options","number",["number","number","number","number"],[m.sampleRate,32784,1,2*f]);if(I=Module.ccall("mid_song_load","number",["number","number"],[r,t]),rval=Module.ccall("mid_istream_close","number",["number"],[r]),0<(g=Module.ccall("mid_song_get_num_missing_instruments","number",["number"],[I])))for(var o=0;o<g;o++){var a=Module.ccall("mid_song_get_missing_instrument","string",["number","number"],[I,o]);!function(n,r,o){var a=new XMLHttpRequest;a.open("GET",r+o,!0),a.responseType="arraybuffer",a.onerror=function(){Y("Error: Cannot retrieve patch file "+r+o)},a.onload=function(){var e,t;200==a.status?(g--,FS.createDataFile("pat/",o,new Int8Array(a.response),!0,!0),MIDIjs.message_callback&&0<g&&MIDIjs.message_callback("Instruments to be loaded: "+g),Y("Instruments to be loaded: "+g),0==g&&(e=Module.ccall("mid_istream_open_mem","number",["number","number","number"],[l,u.length,!1]),t=Module.ccall("mid_create_options","number",["number","number","number","number"],[m.sampleRate,32784,1,2*f]),I=Module.ccall("mid_song_load","number",["number","number"],[e,t]),Module.ccall("mid_istream_close","number",["number"],[e]),Module.ccall("mid_song_start","void",["number"],[I]),b=!0,p=m.createScriptProcessor(f,0,1),s=Module._malloc(2*f),p.onaudioprocess=P,p.connect(m.destination),d=setInterval(W,_),W(),MIDIjs.message_callback&&MIDIjs.message_callback("Playing: "+n),Y("Playing1: "+n+" ... song: "+I))):Y("Error: Cannot retrieve patch file "+r+o+" : "+a.status)},a.send()}(e,M+"pat/",a)}else Module.ccall("mid_song_start","void",["number"],[I]),b=!0,p=m.createScriptProcessor(f,0,1),s=Module._malloc(2*f),p.onaudioprocess=P,p.connect(m.destination),d=setInterval(W,_),W(),MIDIjs.message_callback&&MIDIjs.message_callback("Playing: "+e),Y("Playing2: "+e+" ... song: "+I)}function U(){Y("release_player"),p&&(p.disconnect(),p.onaudioprocess=0,p=0),I&&(Module._free(s),Module._free(l),Module.ccall("mid_song_free","void",["number"],[I]),I=0)}function B(){y||(Y("stopping player"),U(),clearInterval(d),Y(j))}function G(e){return-1!=e.indexOf("http:")?e:(e=e,(r=void 0===r?document.createElement("a"):r).href=e,r.href).replace("https:","http:")}function z(){var e=new Object;-1==w&&(w=(new Date).getTime()),e.time=((new Date).getTime()-w)/1e3,e.status="playing",MIDIjs.player_callback&&MIDIjs.player_callback(e)}function X(e,t){J(),v=R(t),url=G(e);t=v;-1==v&&(t="infinite");e=document.getElementById("scorioMIDI");e?(e.lastChild.setAttribute("src",url),e.lastChild.setAttribute("loop",t)):((e=document.createElement("div")).setAttribute("id","scorioMIDI"),e.innerHTML='&nbsp;<bgsound src="'+url+'" loop="'+t+'" volume="0"/>',document.body&&document.body.appendChild(e)),d=setInterval(z,_),w=-1,p=e,Y("Playing "+url+" ...")}function J(){p&&(p.lastChild.setAttribute("src",G(M)+"../midi/silence.mid"),clearInterval(d),p=0),Y(j)}function K(){var e;p&&((e=p).parentNode.removeChild(e),clearInterval(d),p=0),Y(j)}function Q(e,t,n){var r=Module._malloc(t.length);Module.writeArrayToMemory(t,r);Module.ccall("mid_init","number",[],[]);var o=Module.ccall("mid_istream_open_mem","number",["number","number","number"],[r,t.length,!1]),t=Module.ccall("mid_create_options","number",["number","number","number","number"],[44100,32784,1,2*f]),t=Module.ccall("mid_song_load","number",["number","number"],[o,t]),o=(Module.ccall("mid_istream_close","number",["number"],[o]),Module.ccall("mid_song_get_total_time","number",["number"],[t])/1e3);Module.ccall("mid_song_free","void",["number"],[t]),Module._free(r),n&&n(o)}function Y(){if(h){for(var e=new Array("[midijs] "),t=0;t<arguments.length;t++)e.push(arguments[t]);console.log.apply(null,e)}}function Z(e,t){$(),v=R(t),function(i,s){Y("play_WebAudioWorklet2 "+i),m||(window.AudioContext=window.AudioContext||window.webkitAudioContext,m=new AudioContext);w=-1,m.audioWorklet.addModule(M+k).then(function(){D=new AudioWorkletNode(m,"midijs-audio-worklet");var e=new Object;e.type="set-logging",e.logging=h,D.port.postMessage(e),D.connect(m.destination);var a=D;D.port.
