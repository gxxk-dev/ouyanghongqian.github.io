<html>
<head>
    <meta charset="utf-8"/>
<meta name="description" content=""/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>【教程/记录？】编译适用于掌控版的microPython固件 | GxxkSite</title>

<link rel="shortcut icon" href="https://gxxk.site/favicon.ico?v=1706099014521">

<link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://gxxk.site/styles/main.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css">

<script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets/highlight.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/languages/dockerfile.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/languages/dart.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/moment@2.27.0/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/js/bootstrap.min.js"></script>
<!-- DEMO JS -->
<!--<script src="media/scripts/index.js"></script>-->



    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.css">
</head>
<body>
<div class="main gt-bg-theme-color-first">
    <nav class="navbar navbar-expand-lg">
    <div class="navbar-brand">
        <img class="user-avatar" src="/images/avatar.png" alt="头像">
        <div class="site-name gt-c-content-color-first">
            GxxkSite
        </div>
    </div>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <i class="fas fa-bars gt-c-content-color-first" style="font-size: 18px"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <div class="navbar-nav mr-auto" style="text-align: center">
            
                <div class="nav-item">
                    
                        <a href="/" class="menu gt-a-link">
                            首页
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/archives" class="menu gt-a-link">
                            归档
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/tags" class="menu gt-a-link">
                            标签
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/post/about" class="menu gt-a-link">
                            关于
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/friends/" class="menu gt-a-link">
                            友链
                        </a>
                    
                </div>
            
        </div>
        <div style="text-align: center">
            <form id="gridea-search-form" style="position: relative" data-update="1706099014521" action="/search/index.html">
                <input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="搜索文章" />
                <i class="fas fa-search gt-c-content-color-first" style="position: absolute; top: 9px; left: 10px;"></i>
            </form>
        </div>
    </div>
</nav>

    <div class="post-container">
        <div class="post-detail gt-bg-theme-color-second">
            <article class="gt-post-content">
                <h2 class="post-title">
                    【教程/记录？】编译适用于掌控版的microPython固件
                </h2>
                <div class="post-info">
                    <time class="post-time gt-c-content-color-first">
                        · 2023-12-17 ·
                    </time>
                    
                        <a href="https://gxxk.site/OfZeDgFXM/" class="post-tags">
                            # 固件
                        </a>
                    
                        <a href="https://gxxk.site/W5RsnMhSc/" class="post-tags">
                            # 掌控版
                        </a>
                    
                        <a href="https://gxxk.site/YFCfRHFg_J/" class="post-tags">
                            # microPython
                        </a>
                    
                        <a href="https://gxxk.site/tVMFLaID95/" class="post-tags">
                            # mPython
                        </a>
                    
                        <a href="https://gxxk.site/yKORIepqD-/" class="post-tags">
                            # 编译
                        </a>
                    
                </div>
                <div class="post-content">
                    <blockquote>
<p>不多bb，进入正题 导入词我就懒得写了LOL<br>
本文重点在于环境配置，在阅读本文前您需要熟知有关Linux的基本命令和一些WSL2特性（建议多查多做）<br>
Tip:按顺序继续即可</p>
</blockquote>
<h1 id="提前准备">提前准备</h1>
<p>环境：Windows10LTSC2021（手动安装了MicrosoftStore）<br>
使用终端：新版UI的Powershell与GitBash</p>
<!-- more -->
<figure data-type="image" tabindex="1"><img src="https://image-1302120057.cos.ap-nanjing.myqcloud.com/blog/20231217165011.png" alt="" loading="lazy"></figure>
<p>软件：</p>
<ul>
<li>Git</li>
<li>可正常访问外网的网络环境（推荐<span class="heimu"><a href="https://us.freecat.cloud/#/register?code=q5ppu887">自由猫机场</a>，单月6.9r/100G，体验较好，有IPEL/IPLC专线（此套餐50-99r），一次性85折优惠码：FREECAT</span>）</li>
<li>WSLDebian</li>
</ul>
<h1 id="可选在仅搭载windows系统的macbookair开启虚拟化">(可选)在仅搭载Windows系统的MacBookAir开启虚拟化</h1>
<blockquote>
<p>此处解决方法来源于<a href="https://superuser.com/questions/979695/windows-10-bcdedit-how-to-change-bootmgr-path">Win10如何更改bootmgr路径</a>与<a href="https://www.cnblogs.com/zhangjin1116/articles/17541511.html">Mac OS装Windows系统开启虚拟化</a></p>
</blockquote>
<h2 id="下载refind">下载rEFInd</h2>
<p>rEFInd的可执行文件托管在SourceForge上，下载链接：<a href="https://sourceforge.net/projects/refind/">https://sourceforge.net/projects/refind/</a></p>
<p>进入页面后点击最显眼的<strong>Download</strong>即可下载，将会下载下来一个压缩包，解压到一个临时目录，使用以下命令挂载EFI分区：</p>
<pre><code class="language-bash">mountvol Z: /s
</code></pre>
<p>接着 我们编辑压缩包解压后的文件，在<code>[解压后的目录]/refind-bin-xxxxx/refind/</code>下，有一个文件叫<code>refind.conf-sample</code>，去掉后面的<code>-sample</code>，并且打开文件，找到<code>#enable_and_lock_vmx false</code>，修改为<code>enable_and_lock_vmx true</code></p>
<p>我们切换到<code>Z:/EFI</code>下并复制文件：</p>
<pre><code class="language-bash">xcopy /E [在刚刚修改文件的位置的文件夹] Z:\EFI\refind\
</code></pre>
<p>复制完成后，我们使用<code>BCDEdit</code>修改默认启动项（记得使用管理员权限）：</p>
<pre><code class="language-text">bcdedit /set &quot;{bootmgr}&quot; path \EFI\refind\refind_[系统架构].efi
</code></pre>
<blockquote>
<p>在Win10以前的版本中，<code>&quot;{bootmgr}&quot;</code>应为<code>{bootmgr}</code></p>
</blockquote>
<p>当提示“<strong>操作成功完成。</strong>”后，重启便可以看到，已经开启虚拟化了</p>
<h1 id="部署虚拟机debian11">部署虚拟机Debian11</h1>
<p>打开控制面板，点击程序-启用或关闭Windows功能，勾选&quot;适用于Windows的Linux子系统&quot;，点确定，重启</p>
<p>下载<a href="https://pan.baidu.com/s/1Ra4V_4E4EF8eZNUKK-N3yg?pwd=Gxxk">此链接</a>的内容然后双击运行，点击安装，稍等一会即可</p>
<p>在终端内输入<code>debian</code>，像我这样操作：</p>
<pre><code class="language-text">Installing, this may take a few minutes...
Please create a default UNIX user account. The username does not need to match your Windows username.
For more information visit: https://aka.ms/wslusers
Enter new UNIX username: gxxk   //这一步是设置用户名，建议使用全小写字母/数字
New password:                              //让你设置这个账户的密码，因Linux特性 不会显示此处内容
Retype new password:                  //再输一遍加深印象
passwd: password updated successfully
Installation successful!
适用于 Linux 的 Windows 子系统现已在 Microsoft Store 中可用!
你可以通过运行“wsl.exe --update”或通过访问 https://aka.ms/wslstorepage 进行升级
从 Microsoft Store 安装 WSL 将可以更快地获取最新的 WSL 更新。
有关详细信息，请访问 https://aka.ms/wslstoreinfo

gxxk@W10MacBook:~$sudo passwd root
[sudo] password for gxxk:           //输入你之前设置的密码
New password:                           //再设置一个新密码（后面叫做密码2）
Retype new password:                //再输一遍加深印象
passwd: password updated successfully
</code></pre>
<p>关于内容可以自行翻译，自行理解，完全照抄也是没有问题的</p>
<p>在安装完成后，输入exit并回车，退出Debian，接着执行<code>wsl.exe --update</code>，更新这个WSL子系统，就可以进入下一步操作了</p>
<h2 id="可选更换wsl存储位置">(可选)更换WSL存储位置</h2>
<blockquote>
<p>此操作仅适用于当您的 存储Windows目录的分区（人话：C盘） 空间不够时才建议使用！</p>
</blockquote>
<p>打开终端，列出目前安装的WSL版本</p>
<pre><code class="language-text">wsl -l --all -v
得到回复：
  NAME      STATE           VERSION
* Debian    Stopped         1
</code></pre>
<p>接下来我们导出它（<strong>wsl --export &lt;系统名&gt; &lt;导出目录&gt;</strong>）：</p>
<pre><code class="language-bash">wsl --export Debian G:\WSL初始Debian系统备份_用户名root_密码root.tar
得到回复：
正在导出，这可能需要几分钟时间。
操作成功完成。
</code></pre>
<p>然后我们删掉原来的WSL（wsl --unregister &lt;系统名&gt;）：</p>
<pre><code class="language-bash">wsl --unregister Debian
得到回复：
正在注销。
操作成功完成。
</code></pre>
<p>接着再导入WSL(wsl --import Debian 将要导入到何处 WSL文件位置 --version &lt;WSL版本号&gt;):</p>
<pre><code class="language-bash">wsl --import Debian G:\WSL_Debian G:\WSL初始Debian系统备份_用户名root_密码root.tar --version 2
</code></pre>
<h1 id="linux配置">Linux配置</h1>
<h2 id="换源">换源</h2>
<blockquote>
<p>Debian Buster(Debian10) 以上版本默认支持 HTTPS 源。如果遇到无法拉取 HTTPS 源的情况，请先使用 HTTP 源并安装：</p>
<p><code>apt install apt-transport-https ca-certificates</code></p>
</blockquote>
<pre><code class="language-bash"> nano /etc/apt/sources.list
</code></pre>
<p>编辑器注释掉前4行，输入</p>
<pre><code class="language-text">deb https://mirrors.huaweicloud.com/debian/ bookworm main non-free non-free-firmware contrib
deb-src https://mirrors.huaweicloud.com/debian/ bookworm main non-free non-free-firmware contrib
deb https://mirrors.huaweicloud.com/debian-security/ bookworm-security main
deb-src https://mirrors.huaweicloud.com/debian-security/ bookworm-security main
deb https://mirrors.huaweicloud.com/debian/ bookworm-updates main non-free non-free-firmware contrib
deb-src https://mirrors.huaweicloud.com/debian/ bookworm-updates main non-free non-free-firmware contrib
deb https://mirrors.huaweicloud.com/debian/ bookworm-backports main non-free non-free-firmware contrib
deb-src https://mirrors.huaweicloud.com/debian/ bookworm-backports main non-free non-free-firmware contrib
</code></pre>
<blockquote>
<p>除此之外，你也可使用<a href="https://mirrors.tuna.tsinghua.edu.cn/help/debian">清华大学镜像站</a>提供的Debian软件源</p>
</blockquote>
<h2 id="更新">更新</h2>
<pre><code class="language-bash">apt-get update
</code></pre>
<h2 id="安装各类软件">安装各类软件</h2>
<pre><code class="language-bash">apt-get install git curl wget python3 python-is-python3 python3-pip -y
pip install virtualenv --break-system-packages
</code></pre>
<h2 id="可选设置代理">(可选)设置代理</h2>
<blockquote>
<p>来源于 <a href="https://zhuanlan.zhihu.com/p/153124468">https://zhuanlan.zhihu.com/p/153124468</a></p>
</blockquote>
<p>新建文件（<code>touch &quot;在此处填写文件名&quot;</code>），并使用nano编辑（<code>nano &quot;在此处填写要编辑的文件的文件名&quot;</code>）</p>
<blockquote>
<p>运行nano时，当此目录没有命令中提到的文件时，会自动新建空文件</p>
</blockquote>
<pre><code class="language-bash">nano .proxy
</code></pre>
<p>在文件内写入如下内容</p>
<pre><code class="language-bash">#!/bin/bash
proxy_ip=$(cat /etc/resolv.conf |grep &quot;nameserver&quot; |cut -f 2 -d &quot; &quot;)
                                # 代理IP，此处内容代表Windows宿主机IP
proxy_port=7890    # 代理端口
export ALL_PROXY=&quot;http://$proxy_ip:$proxy_port&quot;
</code></pre>
<p>如果你的软件支持其他代理方式，也可以改写代码，使用代理软件所给的其他命令，例如类似笔者使用的Clash就可以这么配置：</p>
<pre><code class="language-bash">#!/bin/bash
ip=$(cat /etc/resolv.conf |grep &quot;nameserver&quot; |cut -f 2 -d &quot; &quot;)
port=11459
export https_proxy=&quot;http://$ip:$port&quot;
export http_proxy=&quot;http://$ip:$port&quot;
</code></pre>
<p>接下来，您可以使用以下代码在WSL中使用代理了：</p>
<pre><code class="language-bash">source .proxy
</code></pre>
<blockquote>
<p>23.01.24更新：<br>
基于WSL2的一些特性，开机时会自动随机选取一堆端口作为WSL的 <strong>“随机保留端口”</strong> ，这个时候之前的需要用到刚好是保留端口的软件就被顶掉了，就会导致代理软件显示端口为0，目前AFAIK（据我所知），没有绝对的不会被抽中的的端口，总之再换一个就可以了哦~ <span class="heimu" alt="这点东西也要用黑幕包着吗？">网传部分版本的代理软件可以设置动态端口</span></p>
</blockquote>
<h1 id="下载存储库">下载存储库</h1>
<p>打开终端后执行如下代码，（目录下可以有其他文件，下载的时候会<strong>自动新建文件夹</strong><code>mpython</code>）</p>
<p>执行此命令：</p>
<pre><code class="language-bash">git clone https://github.com/labplus-cn/mpython.git --recursive
</code></pre>
<blockquote>
<p>命令意思解析：<br>
git:Git软件的名称<br>
clone:克隆仓库<br>
<a href="https://github.com/labplus-cn/mpython.git">https://github.com/labplus-cn/mpython.git</a>:掌控版固件存放代码的仓库的网址<br>
<code> --recursive</code>:一次性下载这个仓库里面所有的内容</p>
</blockquote>
<p>下载速度取决于你的网速，推荐使用上文提到的<span class="heimu">自由猫机场</span>下载，启动后直接把电脑挂机即可，去吃顿晚餐或玩会hypixel吧</p>
<blockquote>
<p>23.01.24更新：<br>
如直接在裸机进行编译操作（如树莓派），可以尝试使用镜像站点，例如 <strong>FastGit</strong> 等，例如：<br>
<code>git config --global url.&quot;https://hub.fgit.cf/&quot;.insteadOf &quot;https://github.com/&quot;：在每次进行操作时如果在Github服务器上进行操作，那么将服务器地址替换为镜像站地址 </code>git config --global protocol.https.allow always`：设置传输协议总是https<br>
接下来再次体验clone，感受速度差异（记得关掉配置的代理）</p>
</blockquote>
<p>下载完成后，可以看看大小，我这里大小约为3.22G，实际占用5.08G，36486 个文件，5612个文件夹</p>
<p>如果确认下载成功就可以进行下一步了</p>
<h1 id="配置edp-idf">配置EDP-IDF</h1>
<p>切换到<code>mpython/esp-idf</code>目录，安装依赖（<code>pip install -r requirement.txt --break-system-packages</code>），执行<code>install.sh</code>进行安装：</p>
<pre><code class="language-bash">root@W10MacBook:~# cd mpython/esp-idf
root@W10MacBook:~/mpython/esp-idf# pip install -r requirement.txt --break-system-packages
[因篇幅，省略部分内容]
root@W10MacBook:~/mpython/esp-idf# ./install.sh
Installing ESP-IDF tools
Installing tools: xtensa-esp32-elf, esp32ulp-elf, openocd-esp32
[因篇幅，省略部分内容]
All done! You can now run:

  . ./export.sh

root@W10MacBook:~/mpython/esp-idf#
</code></pre>
<p>完成后，执行<code>source ./export.sh</code>，让安装好的工具可以被运行（加入到环境变量）</p>
<blockquote>
<p>笔者执行时会提示<code>tool openocd-esp32 has no installed versions.</code>等内容，此时请执行<code> apt-get install libhidapi-libusb0</code>并再次<code>source ./export.sh</code>解决此Bug<br>
Tip:此解决方法来源于<a href="https://github.com/espressif/esp-idf/issues/5102">官方仓库某一issue</a></p>
</blockquote>
<h1 id="获取mpy-cross">获取mpy-cross</h1>
<p>这里有两种办法，1是我曾提到过的下载pypi上的<code>mpy-cross-v5</code>，2是自行编译，前者方法因曾讲述过便不再列出，此处详解后者方法</p>
<pre><code class="language-bash">cd ~/mpython/micropython/mpy-cross
</code></pre>
<p>执行上方代码，切换到目录，运行后进行下一步</p>
<pre><code class="language-bash">make
</code></pre>
<p>稍等片刻，便会出来如下面展示的内容：</p>
<pre><code class="language-text">LINK mpy-cross
   text    data     bss     dec     hex filename
 287468   17104     896  305468   4a93c mpy-cross
</code></pre>
<p>这就是生成成功了，我们接下来进行下一步操作</p>
<h1 id="编译">编译</h1>
<p>切换到<code>mpython/port</code>目录，执行<strong>make</strong>：</p>
<pre><code class="language-bash">cd ~/mpython/port
make
</code></pre>
<p>在编译完成后，应给出如下字段：</p>
<pre><code class="language-text">Create build/mpython//firmware.bin
bootloader     20336
partitions      3072
application  1640896
total        1706432
</code></pre>
<p>但这还不够，我们通常刷入的官方提供的固件均内嵌了Noto字体便于中文文字显示，接下来我们就需要合并镜像</p>
<h1 id="合并镜像">合并镜像</h1>
<p>切换到<code>~/mpython/port/</code>，我们使用python执行脚本<code>release.py</code>：</p>
<pre><code class="language-bash">cd ~/mpython/port
python ./release.py \
        ./build/mpython/bootloader.bin \
        ./build/mpython/partitions.bin \
        ./build/mpython/application.bin \
        ./Noto_Sans_CJK_SC_Light16.bin \
        ./firmware.bin # 此处&quot;firmware&quot;可随意更改为其他名字
</code></pre>
<p>此时，我们使用<code>mv</code>命令移动到宿主机上：</p>
<pre><code class="language-bash">mv ./[名字].bin /mnt/[盘符]/[文件夹]/[文件夹]/[文件名].bin
</code></pre>
<p>例：</p>
<pre><code class="language-bash">mv ./firmware.bin /mnt/g/PythonProject/mPython/firmware.bin
</code></pre>
<p>即为将当前目录下的firmware.bin移动到宿主机的G盘上的<code>PythonProject</code>文件夹内的<code>mPython</code>文件夹<br>
此时，在对应目录出现的对应文件即为固件，可用于刷入了</p>
<h1 id="懒人包">懒人包</h1>
<p>当然了，如果你是<strong>实在没有能力配置环境</strong>可以下载下方链接的懒人包，使用WSL导入命令导入后，进入<code>~/mpython/port</code>后直接执行make即可编译并合并为一个可用固件</p>
<blockquote>
<p>版本：WSL2<br>
采用版本:<a href="https://github.com/labplus-cn/mpython/commit/c0d2dff16093e6baf568c1eb0fc8df4a61254c76">11.27-c0d2dff</a><br>
用户名/密码：root<br>
WSL 版本： 2.0.9.0</p>
</blockquote>
<p><strong>下载链接：<a href="https://pan.baidu.com/s/1pwae9wDWKuiz1CXJUjGlNQ?pwd=Gxxk">https://pan.baidu.com/s/1pwae9wDWKuiz1CXJUjGlNQ?pwd=Gxxk</a></strong><br>
<strong>提取码：Gxxk</strong></p>

                </div>
            </article>
        </div>

        
            <div class="next-post">
                <div class="next gt-c-content-color-first">下一篇</div>
                <a href="https://gxxk.site/VJNwhqCfL/" class="post-title gt-a-link">
                    【水】记一次有手就行的基于Metasploit的渗透
                </a>
            </div>
        

        
            <span id="/BAt_EdAD5//" class="leancloud_visitors" data-flag-title="【教程/记录？】编译适用于掌控版的microPython固件">
                <em class="post-meta-item-text">阅读量 </em>
                <i class="leancloud-visitors-count">0</i>
            </span>
        

        

        
            <script src='https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js'></script>

<style>
	div#vcomments{
		width:100%;
		max-width: 1000px;
		padding: 2.5%
	}
</style>


	<div id="vcomments"></div>

<script>
	new Valine({
		el: '#vcomments',
		appId: 'Cwz2dUkfTSvc1S9QRUsZ8MBY-MdYXbMMI',
		appKey: 'Z0DQfPDQComYKCZZlqV0rWMH',
		avatar: '',
		pageSize: 5,
		recordIp: true,
		placeholder: '这nm是评论区，不是无人区啊喂！！！',
		visitor: true,
		serverURLs: 'https://valine.gxxk.site',
	});
</script>

        

        <div class="site-footer gt-c-content-color-first">
    <div class="slogan gt-c-content-color-first"></div>
    <div class="social-container">
        
            
        
            
        
            
        
            
        
            
        
            
        
    </div>
    <div class="footer-info">
        Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a><br/>
本站所有文章遵循CC-BY-SA 4.0国际许可协议<br/>
 <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span><br/>本站总访客数<span id="busuanzi_value_site_uv"></span>位<br/>本页总访问量<span id="busuanzi_value_page_pv"></span>次
    </div>
    <div>
        Theme by <a href="https://imhanjie.com/" target="_blank">imhanjie</a>, Powered by <a
                href="https://github.com/getgridea/gridea" target="_blank">Gridea | <a href="https://gxxk.site/atom.xml" target="_blank">RSS</a></a>
    </div>
</div>

<script>
  hljs.initHighlightingOnLoad()
</script>

    </div>
</div>
</body>
</html>
